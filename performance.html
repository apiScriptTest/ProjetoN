<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance | Bankroll Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/pages/performance.css">
</head>
<body>

<div class="app-container">

  <aside class="sidebar-new">
    <div class="brand">
      <div class="logo-icon">B</div>
      <span>Bankroll<strong>Pro</strong></span>
    </div>

    <nav class="side-nav">
      <div class="nav-group">
        <label>PRINCIPAL</label>
        <a href="index.html" class="nav-item">Dashboard</a>
        <a href="performance.html" class="nav-item active">Performance</a>
      </div>
      <div class="nav-group">
        <label>GEST√ÉO</label>
        <a href="bancas.html" class="nav-item">Bancas</a>
      </div>
    </nav>
  </aside>

  <main class="main-viewport">
    <div class="scroll-area">

      <header class="view-header">
        <div class="header-content">
          <h1>An√°lise de Performance</h1>
          <p>M√©tricas de consist√™ncia e intelig√™ncia de dados</p>
        </div>
      </header>

      <section class="top-metrics" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
        <div class="metric-card">
          <span>Profit Factor</span>
          <h2 id="profit-factor">0.00</h2>
        </div>

        <div class="metric-card">
          <span>ROI Total</span>
          <h2 id="total-roi">0%</h2>
        </div>

        <div class="metric-card">
          <span>Banca Atual</span>
          <h2 id="current-balance">‚Ç¨0.00</h2>
        </div>
      </section>

      <div class="performance-flow">

        <section class="chart-box-large">
          <label style="font-size:11px;text-transform:uppercase;color:#64748b;font-weight:800;">
            Evolu√ß√£o de ROI (%)
          </label>

          <div class="chart-container">
            <canvas id="roiChart"></canvas>
          </div>
        </section>

        <section class="support-metrics">

          <div class="insight-card">
            <label>Consist√™ncia</label>

            <div style="height:6px;background:rgba(255,255,255,0.05);border-radius:10px;margin:15px 0;overflow:hidden;">
              <div id="meter-consistency"
                   style="height:100%;width:0%;transition:width 1s ease; background: #00a3ff; box-shadow: 0 0 15px rgba(0, 163, 255, 0.4);">
              </div>
            </div>

            <p id="consistency-text" style="font-size:12px;color:#94a3b8;"></p>
          </div>

          <div class="insight-card">
            <label>Volatilidade</label>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
              <span id="vol-level">---</span>
              <div id="vol-pulse"
                   style="width:12px;height:12px;border-radius:50%;">
              </div>
            </div>
          </div>

        </section>
      </div>
    </div>
  </main>

  <aside class="right-panel">

    <div class="panel-card">
      <h3>Melhores Mercados</h3>
      <div id="market-leaderboard" class="ranking-list"></div>
    </div>

    <div class="panel-card tips">
      <h4>Dica do Sistema</h4>
      <p>
        Um <strong>üü• Cart√£o Vermelho</strong> √© o cisne negro que destr√≥i qualquer modelo estat√≠stico. [cite: 2026-01-20]
        Gere a tua stake com cautela.
      </p>
    </div>

  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const bets = JSON.parse(localStorage.getItem('bets')) || [];
const initialBank = Number(localStorage.getItem('bankroll_base')) || 1000;

function runPerformance() {
  if (!bets.length) return;

  let wins = 0;
  let losses = 0;
  let currentProfit = 0;
  let roiPoints = [0];
  let markets = {};

  bets.forEach(b => {
    const p = Number(b.profit) || 0;
    if (p > 0) wins += p;
    else losses += Math.abs(p);

    currentProfit += p;
    roiPoints.push(((currentProfit / initialBank) * 100).toFixed(2));

    if (!markets[b.market]) markets[b.market] = { w: 0, t: 0 };
    markets[b.market].t++;
    if (b.result === 'win') markets[b.market].w++;
  });

  /* TOP METRICS COM CORES DIN√ÇMICAS */
  const pfValue = (wins / (losses || 1)).toFixed(2);
  const pfElem = document.getElementById('profit-factor');
  pfElem.innerText = pfValue;
  pfElem.style.color = pfValue < 1 ? '#f43f5e' : '#22c55e'; // Vermelho se PF < 1

  const lastRoi = roiPoints.at(-1);
  const roiElem = document.getElementById('total-roi');
  roiElem.innerText = lastRoi + '%';
  roiElem.style.color = lastRoi < 0 ? '#f43f5e' : '#00a3ff'; // Vermelho se preju√≠zo

  document.getElementById('current-balance').innerText = 
    `‚Ç¨${(Number(localStorage.getItem('bankroll')) || initialBank).toFixed(2)}`;

  /* RANKING */
  const rankCont = document.getElementById('market-leaderboard');
  rankCont.innerHTML = '';
  Object.entries(markets)
    .sort((a, b) => (b[1].w / b[1].t) - (a[1].w / a[1].t))
    .forEach(([market, data]) => {
      const perc = ((data.w / data.t) * 100).toFixed(1);
      rankCont.innerHTML += `
        <div class="ranking-item">
          <span class="m-name">${market}</span>
          <span class="m-value">${perc}%</span>
        </div>`;
    });

  /* CHART - REFINADO COM GRADIENTE */
  new Chart(document.getElementById('roiChart'), {
    type: 'line',
    data: {
      labels: roiPoints.map((_, i) => i),
      datasets: [{
        data: roiPoints,
        borderWidth: 3,
        borderColor: lastRoi < 0 ? '#f43f5e' : '#00a3ff', // Linha segue o estado do ROI
        tension: 0.45,
        pointRadius: 0,
        fill: true,
        backgroundColor: ctx => {
          const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 400);
          const color = lastRoi < 0 ? '244, 63, 94' : '0, 163, 255';
          g.addColorStop(0, `rgba(${color}, 0.2)`);
          g.addColorStop(1, `rgba(${color}, 0)`);
          return g;
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } },
        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#64748b', font: { size: 10 } } }
      }
    }
  });

  /* CONSISTENCY */
  const rate = Math.round((bets.filter(b => b.result === 'win').length / bets.length) * 100);
  document.getElementById('meter-consistency').style.width = rate + '%';
  document.getElementById('meter-consistency').style.background = rate < 50 ? '#f43f5e' : '#00a3ff';
  document.getElementById('consistency-text').innerText = `${rate}% de Taxa de Acerto`;

  /* VOLATILITY */
  const vol = document.getElementById('vol-level');
  const pulse = document.getElementById('vol-pulse');
  const isHigh = losses > wins; // Alerta se as perdas superarem ganhos brutos

  vol.innerText = isHigh ? 'ALTA' : 'EST√ÅVEL';
  vol.style.color = isHigh ? '#f43f5e' : '#00a3ff';
  pulse.style.background = isHigh ? '#f43f5e' : '#00a3ff';
  pulse.style.color = pulse.style.background; // Necess√°rio para a anima√ß√£o do CSS ::after
}

runPerformance();
</script>

</body>
</html>