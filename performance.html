<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance | Bankroll Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/pages/performance.css">
</head>
<body>

<div class="app-container">
  <aside class="sidebar-new">
    <div class="brand">
      <div class="logo-icon">B</div>
      <span>Bankroll<strong>Pro</strong></span>
    </div>
    <nav class="side-nav">
      <div class="nav-group">
        <label>PRINCIPAL</label>
        <a href="index.html" class="nav-item">Dashboard</a>
        <a href="performance.html" class="nav-item active">Performance</a>
      </div>
      <div class="nav-group">
        <label>GEST√ÉO</label>
        <a href="bancas.html" class="nav-item">Bancas</a>
      </div>
    </nav>
  </aside>

  <main class="main-viewport">
    <div class="scroll-area">
      <header class="view-header">
        <div class="header-content">
          <h1>An√°lise de Performance</h1>
          <p>M√©tricas de consist√™ncia e intelig√™ncia de dados</p>
        </div>
        <div class="filter-wrapper">
          <select id="period-filter" onchange="runPerformance()" style="background: #1e293b; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
            <option value="all">Todo o Hist√≥rico</option>
            <option value="7">√öltimos 7 dias</option>
            <option value="30">√öltimos 30 dias</option>
            <option value="month">M√™s Atual</option>
          </select>
        </div>
      </header>

      <section class="top-metrics" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
        <div class="metric-card">
          <span>Profit Factor</span>
          <h2 id="profit-factor">0.00</h2>
        </div>
        <div class="metric-card">
          <span>ROI do Per√≠odo</span>
          <h2 id="total-roi">0%</h2>
        </div>
        <div class="metric-card">
          <span>Banca Atual</span>
          <h2 id="current-balance">‚Ç¨0.00</h2>
        </div>
      </section>

      <div class="performance-flow">
        <section class="chart-box-large">
          <label style="font-size:11px;text-transform:uppercase;color:#64748b;font-weight:800;">Evolu√ß√£o de ROI (%) no Per√≠odo</label>
          <div class="chart-container" style="height: 300px;">
            <canvas id="roiChart"></canvas>
          </div>
        </section>

        <section class="support-metrics">
          <div class="insight-card">
            <label>Consist√™ncia</label>
            <div style="height:6px;background:rgba(255,255,255,0.05);border-radius:10px;margin:15px 0;overflow:hidden;">
              <div id="meter-consistency" style="height:100%;width:0%;transition:width 1s ease; background: #00a3ff; box-shadow: 0 0 15px rgba(0, 163, 255, 0.4);"></div>
            </div>
            <p id="consistency-text" style="font-size:12px;color:#94a3b8;"></p>
          </div>

          <div class="insight-card">
            <label>Volatilidade (Risco)</label>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
              <span id="vol-level" style="font-weight: 800; font-family: 'JetBrains Mono';">---</span>
              <div id="vol-pulse" style="width:12px;height:12px;border-radius:50%; background: #64748b;"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <aside class="right-panel">
    <div class="panel-card">
      <h3>Melhores Mercados</h3>
      <div id="market-leaderboard" class="insight-list">
        </div>
    </div>

    <div class="panel-card tips">
      <h4>Dica do Sistema</h4>
      <p>Um <strong>üü• Cart√£o Vermelho</strong> √© o cisne negro que destr√≥i qualquer modelo estat√≠stico. Gere a tua stake com cautela.</p>
    </div>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let roiChartInstance = null;

function runPerformance() {
  const allBets = JSON.parse(localStorage.getItem('bets')) || [];
  const initialBank = Number(localStorage.getItem('bankroll_base')) || 1100;
  const filterValue = document.getElementById('period-filter').value;
  const now = new Date();

  // 1. Ordena√ß√£o Cronol√≥gica
  allBets.sort((a, b) => new Date(a.date) - new Date(b.date));

  // 2. Filtragem
  const filteredBets = allBets.filter(b => {
    if (!b.date) return false;
    const betDate = new Date(b.date);
    if (filterValue === 'all') return true;
    const diffDays = Math.ceil(Math.abs(now - betDate) / (1000 * 60 * 60 * 24));
    if (filterValue === '7') return diffDays <= 7;
    if (filterValue === '30') return diffDays <= 30;
    if (filterValue === 'month') return betDate.getMonth() === now.getMonth();
    return true;
  });

  // 3. C√°lculos
  let wins = 0, losses = 0, currentAccumulatedProfit = 0;
  let roiLabels = ['In√≠cio'], roiData = [0]; 
  let marketsProfit = {};
  let profitsArray = [];

  filteredBets.forEach((bet, index) => {
    const p = parseFloat(bet.profit) || 0;
    profitsArray.push(p);
    
    if (p > 0) wins += p;
    else losses += Math.abs(p);

    currentAccumulatedProfit += p;
    roiData.push(Number(((currentAccumulatedProfit / initialBank) * 100).toFixed(2)));
    
    const d = new Date(bet.date);
    roiLabels.push(`${d.getDate()}/${d.getMonth()+1}`);

    // Agrupar lucro por mercado
    if (bet.market) {
      marketsProfit[bet.market] = (marketsProfit[bet.market] || 0) + p;
    }
  });

  // 4. Update UI: Top Cards
  const pf = losses === 0 ? wins.toFixed(2) : (wins / losses).toFixed(2);
  const pfElem = document.getElementById('profit-factor');
  pfElem.innerText = pf;
  pfElem.style.color = pf >= 1 ? '#22c55e' : '#f43f5e';

  const totalROI = roiData[roiData.length - 1];
  document.getElementById('total-roi').innerText = totalROI.toFixed(2) + '%';
  document.getElementById('total-roi').style.color = totalROI >= 0 ? '#00a3ff' : '#f43f5e';

  const totalProfit = allBets.reduce((acc, b) => acc + (parseFloat(b.profit) || 0), 0);
  document.getElementById('current-balance').innerText = `‚Ç¨${(initialBank + totalProfit).toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;

  // 5. Ranking de Mercados
  const leaderboard = document.getElementById('market-leaderboard');
  const sortedMarkets = Object.entries(marketsProfit).sort((a, b) => b[1] - a[1]).slice(0, 5);
  
  leaderboard.innerHTML = sortedMarkets.length ? sortedMarkets.map(([name, val]) => `
    <div class="mini-stat">
      <span style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</span>
      <strong class="${val >= 0 ? 'text-success' : 'text-danger'}">${val >= 0 ? '+' : ''}‚Ç¨${val.toFixed(2)}</strong>
    </div>
  `).join('') : '<p style="font-size:11px; color:#64748b;">Sem dados suficientes</p>';

  // 6. Volatilidade (Desvio Padr√£o)
  const volLevel = document.getElementById('vol-level');
  const volPulse = document.getElementById('vol-pulse');
  if (profitsArray.length > 1) {
    const mean = profitsArray.reduce((a, b) => a + b) / profitsArray.length;
    const stdDev = Math.sqrt(profitsArray.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / profitsArray.length);
    
    if (stdDev < 30) { volLevel.innerText = "EST√ÅVEL"; volLevel.style.color = "#22c55e"; volPulse.style.background = "#22c55e"; }
    else if (stdDev < 100) { volLevel.innerText = "MODERADA"; volLevel.style.color = "#f59e0b"; volPulse.style.background = "#f59e0b"; }
    else { volLevel.innerText = "ALTA"; volLevel.style.color = "#f43f5e"; volPulse.style.background = "#f43f5e"; }
  }

  // 7. Consist√™ncia
  const winRate = filteredBets.length > 0 ? (filteredBets.filter(b => b.profit > 0).length / filteredBets.length) * 100 : 0;
  document.getElementById('meter-consistency').style.width = winRate + '%';
  document.getElementById('consistency-text').innerText = `${winRate.toFixed(0)}% de Win Rate`;

  updatePerformanceChart(roiLabels, roiData);
}

function updatePerformanceChart(labels, data) {
  const ctx = document.getElementById('roiChart').getContext('2d');
  if (roiChartInstance) roiChartInstance.destroy();

  roiChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        borderColor: '#00a3ff',
        backgroundColor: 'rgba(0, 163, 255, 0.05)',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { grid: { color: 'rgba(255, 255, 255, 0.03)' }, ticks: { color: '#64748b', callback: v => v + '%' } },
        x: { grid: { display: false }, ticks: { color: '#64748b', maxRotation: 0, font: { size: 10 } } }
      }
    }
  });
}

runPerformance();
</script>
</body>
</html>