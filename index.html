<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bankroll Manager</title>

  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/modal.css">
  <link rel="stylesheet" href="assets/css/pages/dashboard.css">
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h1 class="logo">Bankroll</h1>

    <button id="open-bet-modal" class="btn btn-primary add-bet-btn">
      + ADICIONAR APOSTA
    </button>

    <nav class="nav">
      <a href="#" class="nav-link active">Dashboard</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <header class="header">
      <h2>Dashboard</h2>
      <button class="btn btn-ghost" id="reset-btn">Reset</button>
    </header>

    <!-- STATS -->
    <section class="stats">
      <div class="card stat">
        <span class="stat-label">Banca Atual</span>
        <strong class="stat-value bank" id="bank-value">â‚¬0</strong>
      </div>

      <div class="card stat">
        <span class="stat-label">Lucro</span>
        <strong class="stat-value profit" id="profit-value">â‚¬0</strong>
      </div>

      <div class="card stat">
        <span class="stat-label">ROI</span>
        <strong class="stat-value roi" id="roi-value">0%</strong>
      </div>
    </section>

    <!-- CONTENT -->
    <section class="content">

      <div class="card">
        <h3>EvoluÃ§Ã£o da Banca</h3>
        <canvas id="bank-chart" class="chart-placeholder"></canvas>
      </div>

      <div class="card bets-history-card">
        <h3>HistÃ³rico de Apostas</h3>
        <div id="bets-history" class="bets-history"></div>
      </div>

    </section>

  </main>
</div>

<!-- MODAL -->
<div id="bet-modal" class="modal hidden">
  <div class="modal-content">
    <header class="modal-header">
      <h3>Adicionar Aposta ðŸŽ¯</h3>
      <button id="close-bet-modal" class="btn btn-ghost">X</button>
    </header>

    <form id="bet-form" class="modal-form">

      <div class="form-group">
        <label class="label">Stake (â‚¬)</label>
        <input class="input" type="number" id="stake" required>
      </div>

      <div class="form-group">
        <label class="label">Odds</label>
        <input class="input" type="number" step="0.01" id="odds" required>
      </div>

      <div class="form-group">
        <label class="label">Mercado</label>
        <input class="input" type="text" id="market" placeholder="Ex: Over 1.5" required>
      </div>

      <div class="form-group">
        <label class="label">Casa de Aposta</label>
        <input class="input" type="text" id="bookmaker" placeholder="Ex: Bwin" required>
      </div>

      <div class="form-group">
        <label class="label">Resultado</label>
        <select class="input" id="result" required>
          <option value="win">Win</option>
          <option value="loss">Loss</option>
          <option value="void">Void</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">
        Guardar Aposta
      </button>

    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let bankroll = parseFloat(localStorage.getItem('bankroll')) || 1000;
let bets = JSON.parse(localStorage.getItem('bets')) || [];
let chart;

updateStats();
renderChart();
renderHistory();

/* MODAL */
const modal = document.getElementById('bet-modal');
document.getElementById('open-bet-modal').onclick = () => modal.classList.remove('hidden');
document.getElementById('close-bet-modal').onclick = () => modal.classList.add('hidden');
modal.onclick = e => { if(e.target === modal) modal.classList.add('hidden'); };

/* RESET */
document.getElementById('reset-btn').onclick = () => {
  if(confirm('Resetar banca e apostas?')) {
    bankroll = 1000;
    bets = [];
    saveData();
    updateStats();
    renderChart();
    renderHistory();
  }
};

/* ADD BET */
document.getElementById('bet-form').onsubmit = e => {
  e.preventDefault();

  const stake = +stake.value;
  const odds = +odds.value;
  const market = marketInput.value;
  const bookmaker = bookmakerInput.value;
  const result = resultSelect.value;

  let profit = 0;
  if(result === 'win') profit = stake * (odds - 1);
  if(result === 'loss') profit = -stake;

  bets.push({
    stake,
    odds,
    market,
    bookmaker,
    sport: 'Futebol',
    event: market,
    type: 'Simples',
    result,
    profit,
    date: new Date().toISOString()
  });

  bankroll += profit;

  saveData();
  updateStats();
  renderChart();
  renderHistory();

  e.target.reset();
  modal.classList.add('hidden');
};

function updateStats() {
  const totalProfit = bets.reduce((s,b)=>s+b.profit,0);
  const totalStake = bets.reduce((s,b)=>s+b.stake,0);
  const roi = totalStake ? ((totalProfit/totalStake)*100).toFixed(2) : 0;

  document.getElementById('bank-value').textContent = `â‚¬${bankroll.toFixed(2)}`;
  document.getElementById('profit-value').textContent = `${totalProfit>=0?'+':''}â‚¬${totalProfit.toFixed(2)}`;
  document.getElementById('roi-value').textContent = `${roi}%`;
}

function renderHistory() {
  const container = document.getElementById('bets-history');
  container.innerHTML = '';

  if (!bets.length) {
    container.innerHTML = `<p style="color:var(--text-secondary)">Sem apostas registadas.</p>`;
    return;
  }

  const grouped = {};

  bets.slice().reverse().forEach(b => {
    const d = new Date(b.date);
    const key = d.toLocaleDateString('pt-PT', { weekday:'long', day:'2-digit' });
    grouped[key] ??= [];
    grouped[key].push(b);
  });

  Object.entries(grouped).forEach(([day, items]) => {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'bet-day';
    dayDiv.innerHTML = `<div class="bet-day-header">${day}</div>`;

    items.forEach(b => {
      const time = new Date(b.date).toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
      const status = b.result === 'win' ? 'win' : 'loss';

      const card = document.createElement('div');
      card.className = 'bet-card';
      card.innerHTML = `
        <div class="bet-top">
          <div class="bet-meta">
            <span>${time}</span>
            <span>${b.type}</span>
            <span>${b.bookmaker}</span>
            <span>${b.sport}</span>
          </div>
          <div class="bet-profit ${status}">
            ${b.profit>=0?'+':''}â‚¬${b.profit.toFixed(2)}
          </div>
        </div>

        <div class="bet-event">${b.event}</div>
        <div class="bet-market">${b.market}</div>

        <div class="bet-grid">
          <div class="bet-box"><strong>${b.odds}</strong>CotaÃ§Ã£o</div>
          <div class="bet-box"><strong>â‚¬${b.stake}</strong>Valor</div>
          <div class="bet-box"><strong>â‚¬${(b.stake*b.odds).toFixed(2)}</strong>Ganho</div>
          <div class="bet-box"><strong>â‚¬${b.profit.toFixed(2)}</strong>Lucro</div>
        </div>
      `;
      dayDiv.appendChild(card);
    });

    container.appendChild(dayDiv);
  });
}

function saveData() {
  localStorage.setItem('bankroll', bankroll);
  localStorage.setItem('bets', JSON.stringify(bets));
}

function renderChart() {
  const ctx = document.getElementById('bank-chart').getContext('2d');
  if(chart) chart.destroy();

  let value = 1000;
  const data = bets.map(b => value += b.profit);

  chart = new Chart(ctx,{
    type:'line',
    data:{ labels:data.map((_,i)=>`Aposta ${i+1}`), datasets:[{
      data,
      fill:true,
      borderColor:'#38bdf8',
      backgroundColor:'rgba(56,189,248,0.2)',
      tension:0.3
    }]},
    options:{ responsive:true, plugins:{ legend:{ display:false }}}
  });
}
</script>
</body>
</html>
