<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bankroll Manager</title>

  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/pages/dashboard.css">
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h1 class="logo">Bankroll</h1>
    <nav class="nav">
      <a href="#" class="nav-link active">Dashboard</a>
      <a href="#" class="nav-link" id="add-bet-btn">Adicionar Aposta</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- HEADER -->
    <header class="header">
      <h2>Dashboard</h2>
      <button class="btn btn-ghost" id="reset-btn">Reset</button>
    </header>

    <!-- STATS -->
    <section class="stats">
      <div class="card stat">
        <span class="stat-label">Banca Atual</span>
        <strong class="stat-value bank" id="bank-value">€0</strong>
      </div>

      <div class="card stat">
        <span class="stat-label">Lucro</span>
        <strong class="stat-value profit" id="profit-value">€0</strong>
      </div>

      <div class="card stat">
        <span class="stat-label">ROI</span>
        <strong class="stat-value roi" id="roi-value">0%</strong>
      </div>
    </section>

    <!-- CONTENT -->
    <section class="content">
      <div class="card">
        <h3>Evolução da Banca</h3>
        <canvas id="bank-chart" class="chart-placeholder"></canvas>
      </div>

      <div class="card">
        <h3>Adicionar Aposta</h3>
        <form id="bet-form">
          <label class="label" for="stake">Stake (€)</label>
          <input class="input" type="number" id="stake" required />

          <label class="label" for="odds">Odds</label>
          <input class="input" type="number" step="0.01" id="odds" required />

          <label class="label" for="result">Resultado</label>
          <select class="input" id="result" required>
            <option value="win">Win</option>
            <option value="loss">Loss</option>
            <option value="void">Void</option>
          </select>

          <button type="submit" class="btn btn-primary" style="margin-top:1rem;">Adicionar Aposta</button>
        </form>
      </div>
    </section>

  </main>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* =====================================================
   BANKROLL LOCAL STORAGE & LOGIC
===================================================== */

// Inicializa ou carrega banco
let bankroll = parseFloat(localStorage.getItem('bankroll')) || 1000; // default €1000
let bets = JSON.parse(localStorage.getItem('bets')) || [];
let chart;
updateStats();
renderChart();

// Reset botão
document.getElementById('reset-btn').addEventListener('click', () => {
  if(confirm("Resetar banca e apostas?")) {
    bankroll = 1000;
    bets = [];
    saveData();
    updateStats();
    renderChart();
  }
});

// Adicionar aposta
document.getElementById('bet-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const stake = parseFloat(document.getElementById('stake').value);
  const odds = parseFloat(document.getElementById('odds').value);
  const result = document.getElementById('result').value;

  let profit = 0;
  if(result === 'win') profit = stake * (odds - 1);
  else if(result === 'loss') profit = -stake;

  bets.push({ stake, odds, result, profit });
  bankroll += profit;

  saveData();
  updateStats();
  renderChart();

  e.target.reset();
});

// Atualiza métricas no dashboard
function updateStats() {
  const totalProfit = bets.reduce((sum, b) => sum + b.profit, 0);
  const totalStake = bets.reduce((sum, b) => sum + b.stake, 0);
  const roi = totalStake ? ((totalProfit / totalStake) * 100).toFixed(2) : 0;

  document.getElementById('bank-value').textContent = `€${bankroll.toFixed(2)}`;
  document.getElementById('profit-value').textContent = totalProfit >=0 ? `+€${totalProfit.toFixed(2)}` : `-€${Math.abs(totalProfit).toFixed(2)}`;
  document.getElementById('roi-value').textContent = `${roi}%`;
}

// Salva no localStorage
function saveData() {
  localStorage.setItem('bankroll', bankroll);
  localStorage.setItem('bets', JSON.stringify(bets));
}

// ============================
// CHART
// ============================
function renderChart() {
  const ctx = document.getElementById('bank-chart').getContext('2d');

  // limitar numero de pontos para performance
  const maxPoints = 30; // mostrar no máximo 30 apostas
  const displayBets = bets.slice(-maxPoints);

  const labels = displayBets.map((b, i) => `Aposta ${i + 1}`);
  const data = [];
  let cumBank = 1000;
  displayBets.forEach(b => {
    cumBank += b.profit;
    data.push(cumBank);
  });

  // destruir gráfico anterior para evitar duplicação
  if(chart) {
    chart.destroy();
    chart = null;
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.length ? labels : ['Início'],
      datasets: [{
        label: 'Banca (€)',
        data: data.length ? data : [1000],
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.2)',
        fill: true,
        tension: 0.3,
        pointRadius: 3,
        pointBackgroundColor: '#38bdf8'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: false }
      }
    }
  });
}

</script>
</body>
</html>
